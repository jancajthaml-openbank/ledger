version: 2

# ---------------------------------------------------------------------------- #

workflows:

  version: 2

  tag:
    jobs:
      - checkout:
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v[0-9]+(\.[0-9]+)*$/
      - versions:
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v[0-9]+(\.[0-9]+)*$/
      - deps:
          requires:
            - checkout
          filters:
            branches:
              only: master
            tags:
              only: /^v[0-9]+(\.[0-9]+)*$/
      - test:
          requires:
            - deps
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v[0-9]+(\.[0-9]+)*$/
      - bin-amd64:
          requires:
            - deps
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v[0-9]+(\.[0-9]+)*$/
      - bin-armhf:
          requires:
            - deps
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v[0-9]+(\.[0-9]+)*$/
      - bin-arm64:
          requires:
            - deps
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v[0-9]+(\.[0-9]+)*$/
      - debian-amd64:
          requires:
            - bin-amd64
            - versions
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v[0-9]+(\.[0-9]+)*$/
      - debian-armhf:
          requires:
            - bin-armhf
            - versions
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v[0-9]+(\.[0-9]+)*$/
      - debian-arm64:
          requires:
            - bin-arm64
            - versions
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v[0-9]+(\.[0-9]+)*$/
      - publish:
          requires:
            - test
            - debian-amd64
            - debian-armhf
            - debian-arm64
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v[0-9]+(\.[0-9]+)*$/
      - bbtest-amd64:
          requires:
            - publish
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v[0-9]+(\.[0-9]+)*$/
      - release:
          requires:
            - bbtest-amd64
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v[0-9]+(\.[0-9]+)*$/

  commit:
    jobs:
      - checkout
      - versions
      - deps:
          requires:
            - checkout
      - test:
          requires:
            - deps
      - bin-amd64:
          requires:
            - deps
      - bin-armhf:
          requires:
            - deps
      - bin-arm64:
          requires:
            - deps
      - debian-amd64:
          requires:
            - bin-amd64
            - versions
      - debian-armhf:
          requires:
            - bin-armhf
            - versions
      - debian-arm64:
          requires:
            - bin-arm64
            - versions
      - publish:
          requires:
            - test
            - debian-amd64
            - debian-armhf
            - debian-arm64
      - bbtest-amd64:
          requires:
            - publish

  rolling_bbtest:
    triggers:
      - schedule:
          cron: "0 0,6,12,18 * * *"
          filters:
            branches:
              only:
                - master
    jobs:
      - checkout
      - versions
      - bbtest-amd64:
          requires:
            - checkout
            - versions

# ---------------------------------------------------------------------------- #

jobs:

  # -------------------------------------------------------------------------- #

  checkout:
    docker:
      - image: docker:18.06.0-ce-git
        environment:
          - LANG: C.UTF-8
    working_directory: /home/circleci/project
    steps:
      - checkout
      - run: rm /home/circleci/project/.dockerignore
      - save_cache:
          key: code-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
          paths:
            - /home/circleci/project

  # -------------------------------------------------------------------------- #

  versions:
    docker:
      - image: docker:18.06.0-ce-git
        environment:
          - LANG: C.UTF-8
    working_directory: /home/circleci/project
    steps:
      - checkout
      - run:
          name: Update DOCKER_VERSION + TAG_VERSION
          command: |
            if [ -z ${CIRCLE_TAG} ] ; then
              tags=$(git tag --sort=-v:refname | head -1)
              if [ -z ${tags} ] ; then
                VERSION=v0.0.0
              else
                VERSION=${tags}
              fi
              META=$(echo -e ${CIRCLE_BRANCH} | sed 's:.*/::')
              echo -e "${VERSION#v}" > /home/circleci/project/TAG_VERSION
              echo -e "${VERSION}-${META}" > /home/circleci/project/DOCKER_VERSION
            else
              echo -e "${CIRCLE_TAG#v}" > /home/circleci/project/TAG_VERSION
              echo -e "${CIRCLE_TAG}" > /home/circleci/project/DOCKER_VERSION
            fi

            cat /home/circleci/project/TAG_VERSION
            cat /home/circleci/project/DOCKER_VERSION
      - save_cache:
          key: versions-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
          paths:
            - /home/circleci/project/TAG_VERSION
            - /home/circleci/project/DOCKER_VERSION

  # -------------------------------------------------------------------------- #

  deps:
    docker:
      - image: jancajthaml/go:latest
    working_directory: /home/circleci/project
    steps:
      - checkout
      - run:
          name: Ensure services namespace
          command: |
            mkdir -p /go/src/github.com/jancajthaml-openbank
            cp -r \
              /home/circleci/project/services/ledger-rest \
              /go/src/github.com/jancajthaml-openbank/ledger-rest
            cp -r \
              /home/circleci/project/services/ledger-unit \
              /go/src/github.com/jancajthaml-openbank/ledger-unit
      - run:
          name: Sync dependencies
          command: |
            cd /go/src/github.com/jancajthaml-openbank/ledger-rest
            rm go.sum
            go mod vendor
            cd /go/src/github.com/jancajthaml-openbank/ledger-unit
            rm go.sum
            go mod vendor
      - run:
          name: Move vendor folder to project
          command: |
            cp -r \
              /go/src/github.com/jancajthaml-openbank/ledger-rest/vendor \
              /home/circleci/project/services/ledger-rest/vendor
            cp -r \
              /go/src/github.com/jancajthaml-openbank/ledger-unit/vendor \
              /home/circleci/project/services/ledger-unit/vendor
      - save_cache:
          key: dependencies-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
          paths:
            - /home/circleci/project/dev
            - /home/circleci/project/bbtest
            - /home/circleci/project/packaging
            - /go/src/github.com/jancajthaml-openbank/ledger-rest
            - /go/src/github.com/jancajthaml-openbank/ledger-unit

  # -------------------------------------------------------------------------- #

  bin-amd64:
    docker:
      - image: jancajthaml/go:latest
    working_directory: /home/circleci/project
    steps:
      - restore_cache:
          key: code-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          key: dependencies-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - run:
          name: Package binaries
          command: |
            /home/circleci/project/dev/lifecycle/package \
              --arch linux/amd64 \
              --pkg ledger-rest \
              --output /home/circleci/project/packaging/bin
            /home/circleci/project/dev/lifecycle/package \
              --arch linux/amd64 \
              --pkg ledger-unit \
              --output /home/circleci/project/packaging/bin
          no_output_timeout: 5m
      - save_cache:
          key: binaries-amd64-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
          paths:
            - /home/circleci/project/packaging/bin

  # -------------------------------------------------------------------------- #

  bin-armhf:
    docker:
      - image: jancajthaml/go:latest
    working_directory: /home/circleci/project
    steps:
      - setup_remote_docker:
          version: 18.06.0-ce
      - restore_cache:
          key: code-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          key: dependencies-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - run:
          name: Package binaries
          command: |
            /home/circleci/project/dev/lifecycle/package \
              --arch linux/armhf \
              --pkg ledger-rest \
              --output /home/circleci/project/packaging/bin
            /home/circleci/project/dev/lifecycle/package \
              --arch linux/armhf \
              --pkg ledger-unit \
              --output /home/circleci/project/packaging/bin
          no_output_timeout: 5m
      - save_cache:
          key: binaries-armhf-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
          paths:
            - /home/circleci/project/packaging/bin

  # -------------------------------------------------------------------------- #

  bin-arm64:
    docker:
      - image: jancajthaml/go:latest
    working_directory: /home/circleci/project
    steps:
      - setup_remote_docker:
          version: 18.06.0-ce
      - restore_cache:
          key: code-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          key: dependencies-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - run:
          name: Package binaries
          command: |
            /home/circleci/project/dev/lifecycle/package \
              --arch linux/arm64 \
              --pkg ledger-rest \
              --output /home/circleci/project/packaging/bin
            /home/circleci/project/dev/lifecycle/package \
              --arch linux/arm64 \
              --pkg ledger-unit \
              --output /home/circleci/project/packaging/bin
          no_output_timeout: 5m
      - save_cache:
          key: binaries-arm64-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
          paths:
            - /home/circleci/project/packaging/bin

  # -------------------------------------------------------------------------- #

  debian-amd64:
    docker:
      - image: jancajthaml/go:latest
    working_directory: /home/circleci/project
    steps:
      - restore_cache:
          key: code-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          key: binaries-amd64-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          key: versions-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - run:
          name: Package for debian
          command: |
            VERSION=$(cat /home/circleci/project/TAG_VERSION)
            /home/circleci/project/dev/lifecycle/debian \
              --arch amd64 \
              --pkg ledger \
              --version ${VERSION} \
              --source /home/circleci/project/packaging
          no_output_timeout: 5m
      - save_cache:
          key: debian-amd64-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
          paths:
            - /home/circleci/project/packaging/bin

  # -------------------------------------------------------------------------- #

  debian-armhf:
    docker:
      - image: jancajthaml/go:latest
    working_directory: /home/circleci/project
    steps:
      - setup_remote_docker:
          version: 18.06.0-ce
      - restore_cache:
          key: code-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          key: binaries-armhf-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          key: versions-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - run:
          name: Package for debian
          command: |
            VERSION=$(cat /home/circleci/project/TAG_VERSION)
            /home/circleci/project/dev/lifecycle/debian \
              --arch armhf \
              --pkg ledger \
              --version ${VERSION} \
              --source /home/circleci/project/packaging
          no_output_timeout: 5m
      - save_cache:
          key: debian-armhf-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
          paths:
            - /home/circleci/project/packaging/bin

  # -------------------------------------------------------------------------- #

  debian-arm64:
    docker:
      - image: jancajthaml/go:latest
    working_directory: /home/circleci/project
    steps:
      - setup_remote_docker:
          version: 18.06.0-ce
      - restore_cache:
          key: code-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          key: binaries-arm64-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          key: versions-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - run:
          name: Package for debian
          command: |
            VERSION=$(cat /home/circleci/project/TAG_VERSION)
            /home/circleci/project/dev/lifecycle/debian \
              --arch arm64 \
              --pkg ledger \
              --version ${VERSION} \
              --source /home/circleci/project/packaging
          no_output_timeout: 5m
      - save_cache:
          key: debian-arm64-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
          paths:
            - /home/circleci/project/packaging/bin

  # -------------------------------------------------------------------------- #

  publish:
    docker:
      - image: docker:18.06.0-ce
    working_directory: /home/circleci/project
    steps:
      - setup_remote_docker:
          version: 18.06.0-ce
      - restore_cache:
          key: code-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          key: binaries-amd64-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          key: binaries-armhf-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          key: binaries-arm64-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          key: debian-amd64-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          key: debian-armhf-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          key: debian-arm64-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          key: versions-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - run:
          name: Package for docker
          command: |
            DOCKER_VERSION=$(cat /home/circleci/project/DOCKER_VERSION)
            TAG_VERSION=$(cat /home/circleci/project/TAG_VERSION)

            docker build -t openbank/ledger:${DOCKER_VERSION} .

            docker tag openbank/ledger:${DOCKER_VERSION} \
              docker.pkg.github.com/jancajthaml-openbank/ledger/ledger:${TAG_VERSION}

            docker tag openbank/ledger:${DOCKER_VERSION} \
              docker.io/openbank/ledger:${DOCKER_VERSION}

            docker login docker.pkg.github.com -u jancajthaml -p ${GITHUB_RELEASE_TOKEN}
            docker push docker.pkg.github.com/jancajthaml-openbank/ledger/ledger:${TAG_VERSION}

            docker login -u ${DOCKER_USER} -p ${DOCKER_PASSWORD}
            docker push docker.io/openbank/ledger:${DOCKER_VERSION}

  # -------------------------------------------------------------------------- #

  test:
    docker:
      - image: jancajthaml/go:latest
    working_directory: /home/circleci/project
    steps:
      - restore_cache:
          key: dependencies-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - run:
          name: Unit test ledger-rest
          command: |
            /home/circleci/project/dev/lifecycle/test \
              --pkg ledger-rest \
              --output /home/circleci/project/reports
          no_output_timeout: 5m
      - store_test_results:
          path: /home/circleci/project/reports/unit-tests
      - run:
          name: Unit test ledger-unit
          command: |
            /home/circleci/project/dev/lifecycle/test \
              --pkg ledger-unit \
              --output /home/circleci/project/reports
          no_output_timeout: 5m
      - store_test_results:
          path: /home/circleci/project/reports/unit-tests

  # -------------------------------------------------------------------------- #

  bbtest-amd64:
    machine:
      image: circleci/classic:201808-01
      docker_layer_caching: false
    working_directory: /home/circleci/project
    steps:
      - restore_cache:
          key: code-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          key: versions-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - run: docker pull jancajthaml/bbtest:amd64
      - run:
          name: Run blackbox tests
          command: |
            IMAGE_VERSION=$(cat /home/circleci/project/DOCKER_VERSION)
            UNIT_VERSION=$(cat /home/circleci/project/TAG_VERSION)

            docker exec -it $(\
              docker run -d -t \
                --cpuset-cpus=1 \
                -e IMAGE_VERSION="${IMAGE_VERSION}" \
                -e UNIT_VERSION="${UNIT_VERSION}" \
                -e UNIT_ARCH=amd64 \
                -e CI=1 \
                -v /sys/fs/cgroup:/sys/fs/cgroup:ro \
                -v /var/run/docker.sock:/var/run/docker.sock \
                -v /var/lib/docker/containers:/var/lib/docker/containers \
                -v /home/circleci/project/bbtest:/opt/app \
                -v /home/circleci/project/reports:/tmp/reports \
                -w /opt/app \
              jancajthaml/bbtest:amd64 \
            ) python3 /opt/app/main.py
          no_output_timeout: 5m
      - store_test_results:
          path: /home/circleci/project/reports/blackbox-tests/cucumber
      - store_artifacts:
          path: /home/circleci/project/reports/blackbox-tests
          destination: reports

  # -------------------------------------------------------------------------- #

  release:
    docker:
      - image: jancajthaml/go:latest
    working_directory: /home/circleci/project
    steps:
      - restore_cache:
          key: code-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          key: binaries-amd64-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - run:
          command: |
            if [ ! -f ./packaging/bin/ledger-unit-linux-amd64 ] ; then
              echo "ledger-unit-linux-amd64 not found at"
              ls -la ./packaging/bin
              exit 1
            fi
      - run:
          command: |
            if [ ! -f ./packaging/bin/ledger-rest-linux-amd64 ] ; then
              echo "ledger-rest-linux-amd64 not found at"
              ls -la ./packaging/bin
              exit 1
            fi
      - restore_cache:
          key: binaries-armhf-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - run:
          command: |
            if [ ! -f ./packaging/bin/ledger-rest-linux-armhf ] ; then
              echo "ledger-rest-linux-armhf not found at"
              ls -la ./packaging/bin
              exit 1
            fi
      - run:
          command: |
            if [ ! -f ./packaging/bin/ledger-unit-linux-armhf ] ; then
              echo "ledger-unit-linux-armhf not found at"
              ls -la ./packaging/bin
              exit 1
            fi
      - restore_cache:
          key: binaries-arm64-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - run:
          command: |
            if [ ! -f ./packaging/bin/ledger-rest-linux-arm64 ] ; then
              echo "ledger-rest-linux-arm64 not found at"
              ls -la ./packaging/bin
              exit 1
            fi
      - run:
          command: |
            if [ ! -f ./packaging/bin/ledger-unit-linux-arm64 ] ; then
              echo "ledger-unit-linux-arm64 not found at"
              ls -la ./packaging/bin
              exit 1
            fi
      - restore_cache:
          key: debian-amd64-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - run:
          command: |
            if [ ! -f ./packaging/bin/ledger_${CIRCLE_TAG#v}_amd64.deb ] ; then
              echo "ledger_${CIRCLE_TAG#v}_amd64.deb not found at"
              ls -la ./packaging/bin
              exit 1
            fi
      - restore_cache:
          key: debian-armhf-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - run:
          command: |
            if [ ! -f ./packaging/bin/ledger_${CIRCLE_TAG#v}_armhf.deb ] ; then
              echo "ledger_${CIRCLE_TAG#v}_armhf.deb not found at"
              ls -la ./packaging/bin
              exit 1
            fi
      - restore_cache:
          key: debian-arm64-{{ .Environment.CIRCLE_TAG }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Environment.CIRCLE_SHA1 }}
      - run:
          command: |
            if [ ! -f ./packaging/bin/ledger_${CIRCLE_TAG#v}_arm64.deb ] ; then
              echo "ledger_${CIRCLE_TAG#v}_arm64.deb not found at"
              ls -la ./packaging/bin
              exit 1
            fi
      - deploy:
          name: Release artifacts to github
          command: |
            /home/circleci/project/dev/lifecycle/release \
              -v ${CIRCLE_TAG} \
              -t ${GITHUB_RELEASE_TOKEN}

# ---------------------------------------------------------------------------- #
